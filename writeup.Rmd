---
title: 'Waiting for Trial: A Case Study of Detention Times Prior to Sentencing'
author: "Lillian Clark"
date: "12/7/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(magrittr)
library(survival)
library(survminer)
library(rstanarm)
library(scales)
library(RColorBrewer)
library(patchwork)
library(broom)
library(kableExtra)
library(nnet)
```

```{r load-data, message=FALSE}
prison <- read_csv("data/prison-clean.csv")
```

```{r set-colors}
cols <- brewer.pal(8, "Accent")
```

## 1. Introduction

***1.1 Context***

In 2019, 23.3% of incarcerated people in the United States were legally innocent -- they had not been tried on their charges in a court of law.^[World Prison Brief https://www.prisonstudies.org/country/united-states-america]. The Prison Policy Initiative found that the number of people in jail pretrial has nearly quadrupled since the 1980s.^[https://www.prisonpolicy.org/research/pretrial_detention/] Pretrial detention is severely destabilizing for incarcerated individuals and their families. Even a few days in jail can cause people to lose their jobs, their homes, or custody of their children. Studies have shown that people who are detained pretrial are more likely to be convicted and more likely to receive harsher sentences than those who go free.^[need citation] Pretrial detention is also associated with significantly higher recidivism rates.^[Citation]
  
Widespread use of money bail has led to the criminalization of poverty, where individuals who can afford to pay a bail bondsman's fee or to tie up thousands of their own dollars in the court system for months or years can go free, and individuals without those funds sit in jail. This can force innocent individuals who can't pay to claim guilt and accept a plea deal simply to get out of jail faster. In the U.S., there are also clear racial disparities among pretrial detainees. Young Black men are roughly 50% more likely to be detained than white individuals.^[Prison Policy Initiative]. Some people are held in limbo by the criminal legal system for amounts of time comparable to what they would serve if they were convicted. In 2017, The New York Times profiled Kharon Davis, a man who spent at least ten years in county jail awaiting trial. They wrote, "Though he has not been found guilty, Mr. Davis has already served half of the minimum sentence for murder."^[https://www.nytimes.com/2017/09/19/us/alabama-kharon-davis-speedy.html]

Not everyone held in jail is awaiting trial -- there are also individuals with relatively minor convictions like parole violations or misdemeanors who serve their full sentences there, usually for less than a year. The proportion of pretrial detainees in jail populations has increased from 53% in 1970 to 64% in 2015.^[Vera Brief https://www.vera.org/downloads/publications/Justice-Denied-Evidence-Brief.pdf] Some data is available for web scraping from local jails but there are significant problems with transparency, inaccuracies or data entry issues in this data. (INSERT SCREENSHOT OF DURHAM JAIL LIST) These problems make it difficult to determine which jail inhabitants have been convicted and which have not. It also makes studying pretrial detention and inequities harder.^[The Transparency of Jail Data, https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3741638]

The ICPSR 2016 Survey of Prison Inmates contains data from 364 prisons across the United States. 24,848 incarcerated individuals participated, 81% of which were held in state prisons and the other 19% in federal prisons. Part of the survey asked respondents how long they had been detained in jail.

- Error involved in any kind of survey data: jail time is self-reported and not verified from a second source. Also, the survey question doesn't ask participants to specify whether this jail time was pre-detention. Using jail time as length of pretrial detention is not a perfect proxy, but we have reason to believe it is a good one (at least given the way the system is supposed to work), since those serving their sentences for minor convictions in jails should not have been surveyed and split jail-prison sentences are not the norm -- generally, individuals in prison, if they were detained pretrial, did so in jails, and were transferred to prisons after their convictions. 
- 391 individuals, or 1.6% of all observations in the data, reported that they had not yet been sentenced. These pretrial wait times are right-censored, but the group is very small compared to the overall survey participants.
- This data is restricted to individuals in prison, so will exclude those with dismissed or not guilty charges who were also held pretrial. However, it still provides an important window into the punishment people face in America before they are even tried (the wait for justice).

Research questions:

1) When controlling for aspects of the main offense they are prosecuted for and other policy-related covariates, do individuals incarcerated in United States prisons in different racial and ethnic groups wait longer before sentencing?

2) Does time detained pretrial have any relationship with characteristics, such as sex, race, age, and whether they were known by the detained individual, of the victims of "violent" crimes?

Extended pretrial limbo impacts both the detained accused and victims waiting for resolution. Looking at victim characteristics is essential because of the way racial bias and violence have historically been and continue to be codified in the criminal legal system, where white victims are more likely to get attention and justice than Black and brown victims. We see this in the disproportionate national media fervor over cases of white women who go missing or face violence while missing Black and Indigenous women are often ignored or overlooked. Class can play into this as well, with lower-class white victims experiencing different levels of treatment and attention than their upper-class counterparts. Unfortunately the ICPSR survey does not include information on victim income, so I lack the data necessary to add this consideration to analysis. Regardless, the disparities in treatment based on racial dynamics are complicated. It's difficult to outline an ideal outcome because we can imagine scenarios in which less time spent pretrial with this dynamic might be worse for the defendant. Like in the case of Walter McMillian^[Bryan Stevenson, Just Mercy], innocent Black men have frequently been accused of violence against white women and swept through a speedy and unfair trial on a wave of white supremacist fervor. Hasty prosecution and extensive pretrial detention are two very important ways justice is denied, but they manifest as opposite effects in our data. This analysis is limited in its ability to address all that complexity, keeping in mind the meanings of such varied outcomes for both victims and defendants alike. However, it will attempt to shed some light on whether there are differences based on victim characteristics and what the magnitudes of those differences are.

***1.2 Data Description***

**Figure 2: Distribution of Jail Time**

```{r relabel-categories}
prison_nr <- prison %>%
  mutate_if(is.character, ~case_when(
    .x == "Not Reported" ~ "NR", 
    .x == "American Indian/Alaska Native" ~ "American Indian/\nAlaska Native",
    .x == "Asian/Native Hawaiian/Other Pacific Islander" ~ "Asian/Native Hawaiian/\nOther Pacific Islander",
    TRUE ~ .x)) %>%
  mutate(across(c("race", "victim_race", "victim_sex", "victim_hispanic"), 
                ~ifelse(.x == "NR", "Not Reported", .x)))
```

```{r jailtime-eda, fig.height=4}
jailtimeserved_barplot <- prison_nr %>%
  ggplot(aes(x = fct_relevel(jail_time_served, "NR", "No", "Yes"), fill = jail_time_served)) +
  geom_bar(show.legend = FALSE) +
  scale_y_continuous(labels = label_number(accuracy = 1, scale = 1 / 1000, suffix = "K")) +
  scale_fill_manual(values = cols[1:3]) +
  labs(title = "Jail Time Served",
       y = "Individuals",
       x = NULL,
       caption = "NR = Not Reported") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_blank())

jailtime_boxplot <- prison_nr %>%
  filter(!is.na(jail_time), jail_time_served == "Yes") %>%
  ggplot(aes(x = jail_time)) +
  geom_boxplot(width = 0.2, alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 13505, 365 * 5), labels = label_number(accuracy = 1, scale = 1 / 365)) +
  scale_y_continuous(limits = c(-0.1, 0.1)) +
  labs(title = "Jail Time Among Those Who Served", 
       x = "Time Spent in Jail (years)", 
       y = NULL) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

jailtime_histogram <- prison_nr %>%
  filter(!is.na(jail_time), jail_time < 10 * 365, jail_time_served == "Yes") %>%
  ggplot(aes(x = jail_time)) +
  geom_histogram(fill = cols[[3]], color = "black", binwidth = 150) +
  scale_x_continuous(breaks = seq(0, 10 * 365, 365 * 2), labels = label_number(accuracy = 1, scale = 1 / 365)) +
  scale_y_continuous(labels = label_number(accuracy = 1, scale = 1 / 1000, suffix = "K")) +
  coord_cartesian(xlim = c(0, 10 * 365)) +
  labs(title = "Jail Time Served, 10 Years or Less", 
       x = "Time Spent in Jail (years)", 
       y = "Individuals") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank())

jailtime_histogram_censored <- prison_nr %>%
  filter(!is.na(jail_time), jail_time < 10 * 365, jail_time_served == "Yes", sentenced == "No") %>%
  ggplot(aes(x = jail_time)) +
  geom_histogram(fill = cols[[3]], color = "black", binwidth = 150) +
  scale_x_continuous(breaks = seq(0, 10 * 365, 365 * 2), labels = label_number(accuracy = 1, scale = 1 / 365)) +
  scale_y_continuous(breaks = seq(0, 40, 20)) +
  coord_cartesian(xlim = c(0, 10 * 365)) +
  labs(title = "Jail Time for Unsentenced Individuals, (10yr or less, censored)", 
       x = "Time Spent in Jail (years)", 
       y = "Individuals") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank())

(jailtimeserved_barplot | 
    ((jailtime_boxplot / jailtime_histogram / jailtime_histogram_censored) + plot_layout(heights = c(1, 5, 1)))) +
  plot_layout(guides = "collect",
              widths = c(1, 3))
```

In the data, 90.0% of individuals reported serving jail time, 8.3% reported serving no jail time, and 1.7% skipped the related survey questions (jail time served and amount of jail time) (CHECK THIS). FIX FIGURE 457 individuals have missing data for jail time, and INSERT JUSTIFICATION these individuals will be excluded from the primary and secondary analyses (after the jail time served logistic model).

The maximum jail time reported in the data was 37 years, though the majority of individuals served 3 years or less. In 2017, The New York Times wrote that Kharon Davis's 10-year wait pretrial was "among the most protracted" they could find.^[citation] Thus, this will serve as a best estimate for expected maximum jail time, and we will filter the data before analysis to remove observations with jail time greater than or equal to 10 years. This removes 285 observations or 1.2% of the dataset FIX FIGURE. Also, three individuals who did not report their military status and ten individuals who did not report their sentencing status were excluded from analysis. 

ELABORATE ON MISSINGNESS DISCUSSION (from C3 From visualizations of missingness in Appendix section A, we found income seems to have the highest percentage of missingness (14%), followed by years in Durham (3.5%). Based on background knowledge, we assumed the data is **missing at random (MAR)**. We believe the observed missingness can be largely explained by other explanatory variables which we have data for rather than unobserved or unmeasured variables. )

Additionally, incarcerated individuals were asked whether they had been sentenced, and a small number FIX FIGURE (133 individuals, or 0.55% of the data after the above filtering) reported that they had not yet been sentenced. Thus, their pretrial detention times are right-censored. The vast majority of these unsentenced individuals were arrested in more recent years, between 2013 and 2016.

```{r filter-missingness}
prison_filt <- prison %>%
  filter(military != "Not Reported", sentenced != "Not Reported", (jail_time <= 10 * 365 | is.na(jail_time)))

prison_nr %<>%
  filter(military != "NR", sentenced != "NR", (jail_time <= 10 * 365 | is.na(jail_time)))

# data for second analysis
prison_violent <- prison_filt %>%
  filter(controlling_offense_type == "Violent")

prison_violent_nr <- prison_nr %>%
  filter(controlling_offense_type == "Violent")
```

We are interested in controlling for a number of covariates when examining discrepancies in pretrial detention. These can be split into three groups: **policy-related** covariates (arrest year, authority detained by, and state of detention facility), **charge-related** covariates (primary offense and primary offense type, legal status at arrest, posession of firearm at offense, under the influence of alcohol at offense, and under the influence of drugs at offense), and **demographic-related** covariates (age at arrest, race, sex, citizenship, veteran status, education level, and whether homeless in 12 months prior to offense). Policy-related covariates matter because of changes in pretrial detention policy over time (such as during the "tough on crime" era in the 1980s and early 1990s) and across states and jurisdictions. The charge-related covariates represent all the offense-related information available in the ICPSR data, information which would have been available to the district attorneys and judges overseeing these cases and making decisions about bond and detention. And demographic-related covariates allow us to look for discrepancies in treatment between groups of people.

**Figure 3: Distribution of Jail Time by Race of Incarcerated Individual**

```{r indiv-race-eda, fig.height=2}
plot_box <- function(varname_c, dataset){
  p <- dataset %>%
    mutate(victim_race = fct_infreq(victim_race)) %>%
    filter(!is.na(jail_time)) %>%
    ggplot(aes(x = jail_time, y = fct_reorder(get(varname_c), jail_time, .fun = mean, .desc = TRUE))) +
    geom_boxplot() +
    coord_cartesian(xlim = c(0, 3 * 365)) +
    scale_x_continuous(breaks = seq(0, 4 * 365, 365), 
                       labels = label_number(accuracy = 1, scale = 1 / 365)) +
    labs(x = NULL) +
    theme_minimal()
  
  return(p)
}

p1 <- plot_box("race", prison_nr) +
  labs(y = "Race",
       x = "Time Spent in Jail (years)",
       caption = "*x-axis truncated to jail time 3 years and under for readability")

p1
```

Before controlling for covariates, mean jail time seems lowest for white incarcerated individuals and highest for Black individuals and those who did not report their race. The discrepancies between groups in Figure 3 may not appear large. However, in a world where just days or weeks in jail can make a difference in the resources and support networks available to incarcerated individuals, small discrepancies matter.

**Figure 4: Distribution of Jail Time for "Violent" Offenses by Victim Characteristics**

```{r victim-eda, fig.height=4}
p5 <- prison_violent_nr %>%
  mutate(victim_race = fct_infreq(victim_race)) %>%
  ggplot(aes(y = victim_race, fill = victim_race)) +
  geom_bar() +
  labs(x = "Individuals Incarcerated",
       y = "Race of Victim",
       fill = NULL) +
  scale_x_continuous(labels = label_number(accuracy = 1, scale = 1 / 1000, suffix = "K")) +
  scale_fill_manual(values = cols) +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom")

p2 <- plot_box("victim_sex", prison_violent_nr) +
  labs(y = "Sex") +
  theme(axis.text.x = element_blank(),
        plot.title.position = "plot")

p3 <- plot_box("victim_race", prison_violent_nr) +
  labs(y = "Race") +
  theme(axis.text.x = element_blank(),
        plot.title.position = "plot") +
  geom_boxplot(aes(fill = victim_race), show.legend = FALSE) +
  scale_fill_manual(values = cols)

p4 <- plot_box("victim_hispanic", prison_violent_nr) +
  labs(y = "Hispanic",
       x = "Time Spent in Jail (years)",
       caption = "*x-axis truncated to jail time 3 years and under for readability") +
  theme(plot.title.position = "plot")

(p5 | ((p2 / p3/ p4) +
  plot_layout(heights = c(1, 2, 1),
              guides = "collect"))) +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")
```

Data for our secondary analysis contains only individuals serving time for a primary offense labeled 'violent.' Victim information for those convicted of drug and property crimes, offenses which are often victimless or which lack easily identifiable victims, is largely missing. However, 64% of those with a violent primary offense did report victim race. Missingness patterns in victim sex and Hispanic ethnicity were similar. In Figure 4, we observe that individuals convicted of crimes against male victims appear to have a longer mean detention period pretrial. Black and Indigenous victims see the highest mean pretrial detention; white and multiracial victims the lowest. Hispanic victims also appear to see higher mean jail time than non-Hispanic victims.

***1.3 Hypothesis***

Due to the research cited above and preliminary data visualization, we hypothesize that Black, Indigenous and Latinx incarcerated people serve longer jail times. Also, despite the punishing and justice-denying effects of extended pretrial incarceration for those facing charges, due to the imbalance of community attention and outrage surrounding (especially female) white victims versus victims of color, we hypothesize that violent crimes committed against white victims will be associated with shorter detention times pretrial compared to Black and Indigenous victims.

## 2. Methodology

***2.1 Preliminary Analysis: Any Jail Time Served***

Our first goal is to understand whether jail time served is associated with the race of the incarcerated individual. While survival analysis will allow for incorporation of individuals who have not yet been sentenced into our model, roughly 8% of the data consists of people who reported serving no jail time and would have survival time 0. These individuals are important to consider. They likely represent a group that could afford to post bail or pay a bail bondsman, or that live in states with pretrial detention policies that don't heavily rely on money bail, places like New Jersey and Washington D.C..^[citation] To consider those who were not detained pretrial before removing them from the data for survival analysis, we will first conduct multinomial logistic regression with the jail time served indicator as our response and policy, charge, and demographic covariates as predictors.

We opt for multinomial logistic regression over binary logistic regression with only jail time served/not served as outcome in order to account for potential meaning in missingness in the data. Instead of filtering out those with jail time not reported, we consider "Not Reported" as a third outcome in our model. TALK ABOUT ASSUMPTIONS

***2.2 Primary Analysis: Racial Discrepancies in Jail Time***

Our next goal is to observe whether an individual's race is associated with jail time, and if an association does exist, to understand the effect size of race on days in pretrial detention.

**Figure n: Survival Curves for Race of Incarcerated Individual**

```{r prepare-survdata}
survdata <- prison_filt %>%
  filter(!is.na(jail_time), jail_time > 0)

survdata_victim <- survdata %>%
  filter(controlling_offense_type == "Violent")
```

```{r survival-curve, fig.height=5}
psurv1 <- ggsurvplot(survfit(Surv(jail_time, censored) ~ race, 
                   data = survdata[survdata$race %in% c("White", "Black", "Hispanic", "Other"), ]), 
     xlab = "Days in Jail*", ylab = "Estimated Survival Probability",
     #title = "Figure 4: Survival Curve for NBA Players",
     legend.labs = c("White", "Black", "Hispanic", "Other"),
     legend.title = "",
     legend = c(0.75, 0.85),
     ylim = c(0, 1),
     xlim = c(0, 365 * 3),
     conf.int = T, censor = F,
     ggtheme = theme_minimal(),
     palette = cols)

psurv2 <- ggsurvplot(survfit(Surv(jail_time, censored) ~ race, 
                   data = survdata[survdata$race %in% c("American Indian/Alaska Native", 
                                                        "Asian/Native Hawaiian/Other Pacific Islander",
                                                        "Not Reported"), ]), 
     xlab = "Days in Jail*", ylab = NULL,
     #title = "Figure 4: Survival Curve for NBA Players",
     legend.labs = c("American Indian/Alaska Native", "Asian/Native Hawaiian/Other Pacific Islander", 
                     "Not Reported"),
     caption = "*Survival curves plotted separately for most/least common racial groups in data and 
     and truncated to jail times 3 years and under for readability",
     legend.title = "",
     legend = c(0.65, 0.9),
     ylim = c(0, 1),
     xlim = c(0, 365 * 3),
     conf.int = T, censor = F,
     ggtheme = theme_minimal(),
     palette = cols[4:7])

psurv3 <- ggsurvplot(survfit(Surv(jail_time, censored) ~ race_white, 
                   data = survdata), 
     xlab = "Days in Jail", ylab = "Estimated Survival Probability",
     #title = "Figure 4: Survival Curve for NBA Players",
     legend.labs = c("Convicted person of color", "Race not reported", "White convicted person"),
     legend.title = "",
     legend = c(0.5, 0.5),
     ylim = c(0, 1),
     xlim = c(0, 365 * 10),
     conf.int = T, censor = F,
     ggtheme = theme_minimal(),
     palette = cols)

# https://stackoverflow.com/questions/59951004/arrange-ggsurv-plots-with-one-shared-legend
((psurv1$plot | psurv2$plot) / psurv3$plot) +
  plot_layout()

logrank_test <- survdiff(Surv(jail_time, censored) ~ race_white, data = survdata)
logrank_p <- glance(logrank_test)$p.value[[1]]
tidy_logrank <- tidy(logrank_test) %>%
  mutate(calc_oe = ((obs - exp) ^ 2) / exp,
         calc_oez = ((obs - exp) ^ 2 ) / diag(logrank_test$var),
         race_white = case_when(
           race_white == "Y" ~ "White",
           race_white == "N" ~ "Non-white",
           TRUE ~ race_white))
```

We plot survival curves for the data from a non-parametric Kaplan-Meier estimate. When racial categories are simplified to white and non-white, as shown at the bottom of Figure n fIX THIS, the curves for different groups do not cross. They also remain roughly parallel at most survival times. This provides empirical evidence of proportional hazard and establishes the power of a log-rank test as a method to compare groups. Such a test of survival times for white incarcerated individuals, non-white individuals, and those who did not report their race has significant p-value < 0.001 (see Appendix B FIX THIS for full test). We will further explore this racial discrepancy with a survival model.

To further examine the scale of this difference and incorporate confounders, we built an accelerated failure time (AFT) model with error term $\epsilon_i$ normally distributed and survival time $T_i$ log-normally distributed, specified as follows:

$$ \log(T_i) = \beta_0 + \beta_1x_{1i} + \beta_2x_{2i} + ... + \epsilon_i $$

We included the following covariates: primary offense, legal status at arrest, firearm present at offense, under the influence of alcohol at offense, under the influence of drugs at offense, arrest year range, authority held by, state of incarceration, age at arrest, race, sex, citizenship status, veteran status, education level, and whether homeless in the year prior to offense. We compared AFT models with Weibull, log-normal, log-logistic, and exponential hazard distributions in Appendix FIX THIS and conducted model selection with Kaplan-Meier residual plots under the survival functions of these distributions. These plots show the log-normal model performs well, that the curve of its distribution fits the residuals most closely and satisfies assumptions (see Appendix FIX THIS). As shown in the survival curves above, there are several different ways race is encoded in the data, either in 1) the groups white, Black, hispanic, other, American Indian/Alaska Native, Asian/Native Hawaiian/Other Pacific Islander, and not reported; 2) the groups white, non-white, and not reported; and 3) the groups Black, non-Black, and not reported. After model selection, we conducted variable selection via Akaike Information Criterion (AIC) and Bayesian Information Criterion (BIC) to determine which among these three variables to include as a confounder in our log-normal model. Both metrics select the model which labels individuals as white/non-white.

In lieu of an AFT model, we could have pursued a Cox proportional hazards model. Although a semi-parametric model may have done better to capture the complexity in our data, a proportional hazards model would not do well to estimate the magnitude of the difference in jail time served between groups. Our goal is to ascertain how long individuals spend detained pretrial, not their instantaneous hazard rate of sentencing. Therefore, an AFT model is more appropriate for our analysis. Estimating survival times is possible with a Cox proportional hazards model throuogh Breslow estimator calculations, but AFT model coefficients provide a more straightforward approach. CHECK THIS Our two assumptions in this approach are that individuals with censored jail times have the same survival prospects as those without censoring at every point in time and that survival probability functions have remained roughly constant over the period of data collection.

***2.3 Secondary Analysis: Jail Time by Victim Characteristics***

**Figure n: Title**

```{r survival-curve-victim, fig.height=5}
psurv1 <- ggsurvplot(survfit(Surv(jail_time, censored) ~ victim_race, 
                   data = survdata_victim[survdata_victim$victim_race %in% 
                                            c("White", "Black", "Not Reported"), ]), 
     xlab = "Days in Jail*", ylab = "Estimated Survival Probability",
     #legend.labs = c("Black", "Not Reported", "White"),
     legend.title = "",
     legend = c(0.75, 0.85),
     ylim = c(0, 1),
     xlim = c(0, 365 * 3),
     conf.int = T, censor = F,
     ggtheme = theme_minimal(),
     palette = cols)

psurv2 <- ggsurvplot(survfit(Surv(jail_time, censored) ~ victim_race, 
                   data = survdata_victim[survdata_victim$victim_race %in% c("American Indian/Alaska Native", 
                                                        "Asian/Native Hawaiian/Other Pacific Islander",
                                                        "Multiple"), ]), 
     xlab = "Days in Jail*", ylab = NULL,
     legend.labs = c("American Indian/Alaska Native", "Asian/Native Hawaiian/Other Pacific Islander", 
                     "Multiracial"),
     caption = "*Survival curves plotted separately for most/least common racial groups in data and 
     and truncated to jail times 3 years and under for readability",
     legend.title = "",
     legend = c(0.65, 0.9),
     ylim = c(0, 1),
     xlim = c(0, 365 * 3),
     conf.int = T, censor = F,
     ggtheme = theme_minimal(),
     palette = cols[4:7])

psurv3 <- ggsurvplot(survfit(Surv(jail_time, censored) ~ victim_race_white, 
                   data = survdata_victim), 
     xlab = "Days in Jail", ylab = "Estimated Survival Probability",
     legend.labs = c("Victim of color", "Race not reported", "White victim"),
     legend.title = "",
     legend = c(0.5, 0.5),
     ylim = c(0, 1),
     xlim = c(0, 365 * 10),
     conf.int = T, censor = F,
     ggtheme = theme_minimal(),
     palette = cols)

((psurv1$plot | psurv2$plot) / psurv3$plot) +
  plot_layout()

logrank_test <- survdiff(Surv(jail_time, censored) ~ victim_race_white, data = survdata_victim)
logrank_p <- glance(logrank_test)$p.value[[1]]
tidy_logrank <- tidy(logrank_test) %>%
  mutate(calc_oe = ((obs - exp) ^ 2) / exp,
         calc_oez = ((obs - exp) ^ 2 ) / diag(logrank_test$var),
         victim_race_white = case_when(
           victim_race_white == "Y" ~ "White",
           victim_race_white == "N" ~ "Non-white",
           TRUE ~ victim_race_white))
```

Our methodology for our secondary analysis of victim characteristics is identical to the one above, with the exception of the initial inclusion of victim race, victim sex, victim age, victim hispanic ethnicity and whether the victim was known by the individual as additional covariates. Our interpretation goals remain oriented on survival times, not hazards, so we build AFT models to compare. We find a log-normal AFT model to be the best fit when its hazard distribution is compared to a plot of the Kaplan-Meier residuals, and comparing AIC and BIC leads us to select victim race white/non-white as our method of encoding race.

## 3. Results

***3.1 Preliminary Analysis***

```{r multinomial-model, include=F}
m1 <- multinom(jail_time_served ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior,
               data = prison_filt)
```

```{r multinomial-results}
tidy_multinom <- tidy(m1, exponentiate = FALSE)

tidy_multinom$p.value <- pvalue(tidy_multinom$p.value,
                              accuracy = 0.001, 
                              decimal.mark = ".",
                              add_p = FALSE)

tidy_multinom_sig <- tidy_multinom %>%
  filter((str_detect(term, "age_at_arrest") | str_detect(term, "race") | str_detect(term, "sex")
         | str_detect(term, "citizen") | str_detect(term, "military") 
         | str_detect(term, "education") | str_detect(term, "homeless_12mo_prior")) &
         p.value <= 0.05)

kable_styling(kable(tidy_multinom_sig, digits = c(3,3,3,3), 
                    caption = "Multinomial Logistic Model Output",
                    col.names = c("Y Level", "Model Term", "Estimate", 
                                  "Standard Error", "Test Statistic", "p-Value")),
              latex_options = "HOLD_position")
```

***3.2 Primary Analysis***

```{r}
aft_ln3 <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_white + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                  dist = "lognormal")

tidy_aft1 <- tidy(aft_ln3)
tidy_aft1$p.value <- pvalue(tidy_aft1$p.value,
                              accuracy = 0.001, 
                              decimal.mark = ".",
                              add_p = FALSE)
tidy_aft1_sig <- tidy_aft1 %>%
  filter((str_detect(term, "age_at_arrest") | str_detect(term, "race") | str_detect(term, "sex")
         | str_detect(term, "citizen") | str_detect(term, "military") 
         | str_detect(term, "education") | str_detect(term, "homeless_12mo_prior")) &
           p.value <= 0.05)

kable_styling(kable(tidy_aft1_sig, digits = c(3,3,3,3), 
                    caption = "AFT (log-normal) Model Output (with race white/non-white)",
                    col.names = c("Model Term", "Estimate", "Standard Error", "Test Statistic", "p-Value")),
              latex_options = "HOLD_position")
```

***3.3 Secondary Analysis***

```{r}
aft_ln3_v <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_white + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race_white + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim, 
                  dist = "lognormal")

tidy_aft2 <- tidy(aft_ln3_v)
tidy_aft2$p.value <- pvalue(tidy_aft2$p.value,
                              accuracy = 0.001, 
                              decimal.mark = ".",
                              add_p = FALSE)

tidy_aft2_sig <- tidy_aft2 %>%
  filter((str_detect(term, "age_at_arrest") | str_detect(term, "race") | str_detect(term, "sex")
         | str_detect(term, "citizen") | str_detect(term, "military") 
         | str_detect(term, "education") | str_detect(term, "homeless_12mo_prior")
         | str_detect(term, "victim")) &
           p.value <= 0.05)

kable_styling(kable(tidy_aft2_sig, digits = c(3,3,3,3), 
                    caption = "AFT (log-normal) Model Output (with race white/non-white)",
                    col.names = c("Model Term", "Estimate", "Standard Error", "Test Statistic", "p-Value")),
              latex_options = "HOLD_position")
```

## 4. Discussion

***4.1 Conclusions***

***4.2 Limitations and Future Directions***

***4.3 Summary***

## Appendix 

```{r}
aft_ln <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                  dist = "lognormal")

aft_ln2 <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_black + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                  dist = "lognormal")

aft_ln3 <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_white + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                  dist = "lognormal")

aft_e <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata,  
                 dist = "exponential")

aft_w <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                 dist = "weibull")

aft_l <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                 dist = "loglogistic")

resids <- (log(survdata$jail_time) - aft_ln$linear.predictors) / (aft_ln$scale)
m1 <- survfit(Surv(resids, censored) ~ 1, data = survdata)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Log-Normal Model with All Confounders")
exp.x <- seq(min(resids), max(resids), length = 100)
exp.y <- pnorm(exp.x, lower.tail = F)
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata$jail_time) - aft_e$linear.predictors) / (aft_e$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Exponential Model with All Confounders")
exp.y <- exp(-exp(exp.x))
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata$jail_time) - aft_w$linear.predictors) / (aft_w$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Weibull Model with All Confounders")
exp.y <- exp(-exp(exp.x))
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata$jail_time) - aft_l$linear.predictors) / (aft_l$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Logistic Model with All Confounders")
exp.y <- plogis(exp.x, lower.tail = F)
lines(exp.x, exp.y, col = "red", lwd = 2)

AIC <- c(AIC(aft_ln), AIC(aft_ln2), AIC(aft_ln3))
BIC <- c(BIC(aft_ln), BIC(aft_ln2), BIC(aft_ln3))

var_select <- as.data.frame(t(tibble(AIC, BIC)))

kable(var_select, digits = c(1, 1, 1, 1, 1), 
      caption = "AIC and BIC for Log-normal AFT Models by Race Encoding Method",
      col.names = c("Race complete", "Race Black/non-Black", "Race white/non-white")) %>%
  kable_styling(latex_options = "HOLD_position")
```


```{r}
aft_ln <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_white + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim, 
                  dist = "lognormal")

aft_ln2 <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_white + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race_black + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim, 
                  dist = "lognormal")

aft_ln3 <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race_white + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race_white + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim, 
                  dist = "lognormal")

aft_e <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim,  
                 dist = "exponential")

aft_w <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim, 
                 dist = "weibull")

aft_l <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year_range + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior
                  + victim_race + victim_sex + victim_known + victim_hispanic + victim_age, 
                  data = survdata_victim, 
                 dist = "loglogistic")

resids <- (log(survdata_victim$jail_time) - aft_ln$linear.predictors) / (aft_ln$scale)
m1 <- survfit(Surv(resids, censored) ~ 1, data = survdata_victim)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Log-Normal Model with All Confounders")
exp.x <- seq(min(resids), max(resids), length = 100)
exp.y <- pnorm(exp.x, lower.tail = F)
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata_victim$jail_time) - aft_e$linear.predictors) / (aft_e$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Exponential Model with All Confounders")
exp.y <- exp(-exp(exp.x))
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata_victim$jail_time) - aft_w$linear.predictors) / (aft_w$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Weibull Model with All Confounders")
exp.y <- exp(-exp(exp.x))
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata_victim$jail_time) - aft_l$linear.predictors) / (aft_l$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Logistic Model with All Confounders")
exp.y <- plogis(exp.x, lower.tail = F)
lines(exp.x, exp.y, col = "red", lwd = 2)

AIC <- c(AIC(aft_ln), AIC(aft_ln2), AIC(aft_ln3))
BIC <- c(BIC(aft_ln), BIC(aft_ln2), BIC(aft_ln3))

var_select <- as.data.frame(t(tibble(AIC, BIC)))

kable(var_select, digits = c(1, 1, 1, 1, 1), 
      caption = "AIC and BIC for Log-normal AFT Models by Race Encoding Method",
      col.names = c("Race complete", "Race Black/non-Black", "Race white/non-white")) %>%
  kable_styling(latex_options = "HOLD_position")
```


- See Appendx for model assumptions, multicollinearity analysis, discussion of residuals

- Description of coefficients of interest, any significant results, and effect size.
