---
title: "scratchwork"
author: "Lillian Clark"
date: "11/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(survival)
library(survminer)
library(rstanarm)
library(mice)
```

```{r load-data}
load("data/37692-0001-Data.rda")
prison <- da37692.0001
```

```{r clean-data}
prison_filt <- prison %>%
  select(current_age = RV0001, race = RV0003, citizen = RV0004,
         military = RV0008, controlling_offense = RV0036, controlling_offense_type = RV0037,
         education = RV0054, homeless_12mo_prior = V0961, firearm_at_offense = RV0095,
         arrest_year = V0055Y, admit_year = V0056Y, held_by = V0071, sentenced = V0073, awaiting = V0075, 
         arrested_during_status = V0078, jail_time_served = V0390, jail_time_yr = V0391, jail_time_mo = V0392,
         jail_time_wk = V0393, jail_time_dy = V0394,
         victim_hispanic = V0481, victim_hispanic2 = V0544, victim_white = V0482,
         victim_white2 = V0545, victim_black = V0483, victim_black2 = V0546, 
         victim_native_american = V0484, victim_native_american2 = V0547, victim_asian = V0485, victim_asian2 = V0548,
         victim_hawaiian = V0486, victim_hawaiian2 = V0549, victim_race = V0488, victim_race2 = V0551,
         victim_sex = V0489, victim_age = V0490, victim_known = V0491, victim_offense = V0495,
         victim_injured = V0496, victim_died = V0497, state = V0772, sex = V1212, 
         alc_at_offense = V1267, drug_at_offense = V1326) %>%
  mutate(
    across(c("jail_time_yr", "jail_time_mo", "jail_time_wk", "jail_time_dy"), 
                ~ifelse(.x < 0, as.numeric(NA), .x)),
    jail_time_yr = ifelse(jail_time_yr > 40, as.numeric(NA), jail_time_yr),
    time_estimate = admit_year - arrest_year) %>%
  rowwise() %>%
  mutate(
    jail_time = case_when(
      is.na(jail_time_yr) & is.na(jail_time_mo) & is.na(jail_time_wk) & is.na(jail_time_dy) ~ as.numeric(NA),
      TRUE ~ round(sum(c(jail_time_yr * 365, jail_time_mo * 365 / 12, jail_time_wk * 7, jail_time_dy), 
                       na.rm = TRUE), 0))) %>%
    ungroup()

prison_filt %>%
  count(victim_hispanic2, victim_hispanic)

attributes(prison_filt)$variable.labels <- NULL

prison_filt %<>%
  select(current_age, race, sex, citizen, military, education, homeless_12mo_prior, jail_time_served, jail_time,
         arrest_year, admit_year, held_by, state, sentenced, controlling_offense, controlling_offense_type,
         arrested_during_status, firearm_at_offense, alc_at_offense, drug_at_offense, 
         victim_hispanic, victim_hispanic2, victim_white, victim_white2, victim_black, victim_black2, 
         victim_native_american, victim_native_american2, victim_asian, victim_asian2,
         victim_hawaiian, victim_hawaiian2, victim_race, victim_race2,
         victim_sex, victim_age, victim_known, victim_offense) %>%
  mutate(across(c("race", "citizen", "military", "controlling_offense", "controlling_offense_type",
                  "education", "firearm_at_offense", "held_by", "sentenced", "arrested_during_status",
                  "jail_time_served", "sex", "alc_at_offense", "drug_at_offense", starts_with("victim"),
                  "homeless_12mo_prior"), 
                ~ str_remove(as.character(.x), "\\(\\d+\\) \\d+ = ")),
         across(c("arrest_year", "admit_year"), ~ifelse(.x == 999999, as.numeric(NA), .x)),
         across(c("sex", "alc_at_offense", "drug_at_offense", "sentenced", starts_with("victim"), "homeless_12mo_prior"), 
                ~ifelse(.x %in% c("(-1) -1 = Don't Know", "(-2) -2 = Refusal"), as.character(NA), .x)),
         race = str_remove(race, " \\(NH\\)"),
         race = case_when(
           race == "Uncategorized - Missing" ~ as.character(NA), 
           race == "2+ Races" ~ "Other",
           TRUE ~ race),
         citizen = ifelse(citizen == "Missing", as.character(NA), citizen),
         military = ifelse(military == "(98) 98 = DK/REF", as.character(NA), military),
         controlling_offense_type = 
           ifelse(controlling_offense_type == "DK/REF", as.character(NA), controlling_offense_type),
         education = ifelse(education == "Missing", as.character(NA), education),
         firearm_at_offense = 
           ifelse(firearm_at_offense %in% c("DK/REF", "Missing (in-universe)"), as.character(NA), firearm_at_offense),
         held_by = case_when(
           held_by == "State correctional authorities such as the state department of corrections" ~ "State",
           held_by %in% c("Federal Bureau of Prisons", "U.S. Marshals Service") ~ "Federal",
           held_by == "Local correctional authorities such as local jails or detention centers" ~ "Local",
           held_by == "U.S. Immigration and Customs Enforcement" ~ "ICE",
           held_by == "Some Other Authority" ~ "Other",
           TRUE ~ as.character(NA)),
         arrested_during_status = case_when(
           arrested_during_status == "None of These (No Parole, Probation, or Escape)" ~ "None",
           arrested_during_status == "Probation, including Shock Probation and Split Sentences" ~ "Probation",
           arrested_during_status == "Parole or Post-Release Supervision after serving time" ~ "Parole",
           arrested_during_status %in% c("(-2) -2 = Refusal", "(-1) -1 = Don't Know") ~ as.character(NA),
           TRUE ~ arrested_during_status),
         max_time_est = admit_year - arrest_year,
         max_time_est = ifelse(max_time_est < 0, as.numeric(NA), max_time_est),
         jail_time_served = case_when(
           jail_time_served == "Specify Jail Time" ~ "Yes",
           jail_time_served == "No Time in Jail" ~ "No",
           TRUE ~ as.character(NA)),
         jail_time = ifelse(jail_time_served == "No", 0, jail_time),
         victim_race = case_when(
           victim_race == "Contained a don't know response" ~ "Unknown",
           victim_race == "Contained at least one valid response entry" ~ 
             str_remove_all(str_remove_all(paste0(victim_white, ",", victim_black, ",", victim_native_american, 
                    ",", victim_asian, ",", victim_hawaiian), "Blank"), ","),
           TRUE ~ as.character(NA)),
         victim_race = case_when(
         victim_race %in% c("White" , "Unknown") ~ victim_race,
         victim_race == "Black or African American" ~ "Black",
         victim_race == "American Indian or Alaska Native" ~ "American Indian/Alaska Native",
         victim_race %in% c("Native Hawaiian or Other Pacific Islander", 
                            "Asian") ~ "Asian/Native Hawaiian/Other Pacific Islander",
         is.na(victim_race) ~ victim_race,
         TRUE ~ "Multiple"),
         victim_race2 = case_when(
           victim_race2 == "Contained a don't know response" ~ "Unknown",
           victim_race2 == "Contained at least one valid response entry" ~ 
             str_remove_all(str_remove_all(paste0(victim_white2, ",", victim_black2, ",", victim_native_american2, 
                    ",", victim_asian2, ",", victim_hawaiian2), "Blank"), ","),
           TRUE ~ as.character(NA)),
         victim_race2 = case_when(
         victim_race2 %in% c("White" , "Unknown") ~ victim_race2,
         victim_race2 == "Black or African American" ~ "Black",
         victim_race2 == "American Indian or Alaska Native" ~ "American Indian/Alaska Native",
         victim_race2 %in% c("Native Hawaiian or Other Pacific Islander", 
                            "Asian") ~ "Asian/Native Hawaiian/Other Pacific Islander",
         is.na(victim_race2) ~ victim_race2,
         TRUE ~ "Multiple"),
         victim_race = ifelse(is.na(victim_race), victim_race2, victim_race),
         victim_hispanic2 = case_when(
           victim_hispanic2 %in% c("All were Hispanic", "Most were Hispanic", "They were evenly divided") ~ "Yes",
           victim_hispanic2 == "Most were Non-Hispanic" ~ "No",
           TRUE ~ victim_hispanic2),
         victim_hispanic = ifelse(is.na(victim_hispanic), victim_hispanic2, victim_hispanic)) %>%
  select(-victim_hispanic2, -victim_white, -victim_white2, -victim_black, -victim_black2, 
         -victim_native_american, -victim_native_american2, -victim_asian, -victim_asian2,
         -victim_hawaiian, -victim_hawaiian2, -victim_race2)

# prepare for survival analysis
prison_filt %<>%
  mutate(censored = case_when(
    sentenced == "No" ~ 0,
    sentenced == "Yes" ~ 1,
    TRUE ~ as.numeric(NA)))
```

Motivation:
Pre-trial detention is significant and destabilizing. People held in limbo by the criminal legal system for years. Some data available for scraping from jails but lots of problems with transparency here. ICPSR Survey of Prison Inmates 2016 allows a look at a large population across the U.S. and hoow long they reported they were detained in jails. The majority have been sentenced, although some reported that they had not been sentenced -- for these individuals, the time spent waiting for trial, or pre-sentencing, is censored. This data is restricted to individuals spending time in prison, so will exclude a majority of those with dismissed or not guilty charged who were also held pretrial. However, it still provides an important window into the punishment people face in America before they are even tried, the wait for justice.

Research questions:

1) When controlling for aspects of the main offense they are prosecuted for, do individuals incarcerated in United States prisons in different racial and ethnic groups wait longer before sentencing? Are there other factors that contribute to longer time spent in pre-trial detention?

2) Does time detained pre-trial have any relationship with characteristics of the victims of "violent" crimes, such as sex, race, age, and whether they are known by the detained individual?


```{r}
# what to do about these
prison_filt %>%
  filter(max_time_est > 0 & jail_time / 365 > max_time_est) %>%
  select(jail_time, max_time_est, admit_year, arrest_year)
```

```{r}
prison_filt <- read_csv("data/prison-clean.csv")

# data for first analysis
data <- prison_filt %>%
  select(!starts_with("victim"))

# data for second analysis
data_v <- prison_filt %>%
  filter(controlling_offense_type == "Violent")
```


```{r eda}
prison_filt %>%
  ggplot(aes(x = jail_time)) +
  geom_histogram()

data_v %>%
  ggplot(aes(x = jail_time)) +
  geom_histogram() +
  scale_x_continuous(limits = c(0, 1825)) +
  coord_cartesian(ylim = c(0, 3000))

prison_filt %>%
  ggplot(aes(x = jail_time)) +
  geom_histogram() +
  scale_x_continuous(limits = c(0, 1825)) +
  coord_cartesian(ylim = c(0, 3000))

prison_filt %>%
  ggplot(aes(y = log(jail_time), x = race)) +
  geom_boxplot()

covariates <- colnames(prison_filt)

covariates <- covariates[covariates != "jail_time"]
  

plot_box <- function(varname_c){
  p1 <- prison_filt %>%
    filter(jail_time <= 1825) %>%
    ggplot(aes(x = jail_time, y = fct_reorder(get(varname_c), jail_time, .fun = median, .desc = TRUE))) +
    geom_boxplot() +
    labs(y = "Days in Jail", x = varname_c) +
    theme_minimal()
  
  return(p1)
}

plot_box("sex")
plot_box("race")
plot_box("race_black")
plot_box("race_white")
plot_box("citizen")
plot_box("military")
plot_box("education")
plot_box("homeless_12mo_prior")
plot_box("held_by")
plot_box("sentenced")
plot_box("controlling_offense")
plot_box("controlling_offense_type")
plot_box("arrested_during_status")
plot_box("firearm_at_offense")
plot_box("alc_at_offense")
plot_box("drug_at_offense")
plot_box("state")

plot_box_v <- function(varname_c){
  p1 <- data_v %>%
    filter(jail_time <= 1825) %>%
    ggplot(aes(y = jail_time, x = fct_reorder(get(varname_c), jail_time, .fun = median, .desc = TRUE))) +
    geom_boxplot() +
    labs(y = "Days in Jail", x = varname_c) +
    theme_minimal()
  
  return(p1)
}

plot_box_v("victim_hispanic")
plot_box_v("victim_race")
plot_box_v("victim_sex")
plot_box_v("victim_known")
plot_box_v("victim_age")
plot_box_v("victim_offense")
```

offense covariates: controlling_offense, controlling_offense_type, arrested_during_status, firearm_at_offense, alc_at_offense, drug_at_offense
policy covariates: arrest_year, held_by, state
demographic/subject characteristic covariates: age, race, sex, citizen, military?, education, homeless_12mo_prior
then also victim variables:

```{r}
survdata <- data

ggsurvplot(survfit(Surv(jail_time, censored) ~ state, data = survdata),
     legend.title = "",
     conf.int = F, censor = F,
     xlim = c(0, 2500),
     ggtheme = theme_minimal())

ggsurvplot(survfit(Surv(jail_time, censored) ~ victim_race, data = data_v),
     legend.title = "",
     conf.int = F, censor = F,
     xlim = c(0, 2500),
     ggtheme = theme_minimal())
```


logrank_test <- survdiff(Surv(yos, retired) ~ onedone01, data = surv_data)
logrank_p <- round(glance(logrank_test)$p.value[[1]], 4)
tidy_logrank <- tidy(logrank_test) %>%
  mutate(calc_oe = ((obs - exp) ^ 2) / exp,
         calc_oez = ((obs - exp) ^ 2 ) / diag(logrank_test$var),
         onedone01 = ifelse(onedone01 == 1, "One-and-Done", "Longer College Stay"))


offense covariates: controlling_offense, controlling_offense_type, arrested_during_status, firearm_at_offense, alc_at_offense, drug_at_offense
policy covariates: arrest_year, held_by, state
demographic/subject characteristic covariates: current_age, race, sex, citizen, military?, education, homeless_12mo_prior

names(aft_ln$coefficients) <- c("(Intercept)", 
                                "One-and-Done Status", 
                                "Plays Position F", 
                                "Plays Position G", 
                                "Player Height (in)",
                                "Foreign Nationality")
tidy_aft <- tidy(aft_ln)
tidy_aft$p.value <- pvalue(tidy_aft$p.value,
                              accuracy = 0.001, 
                              decimal.mark = ".",
                              add_p = FALSE)
kable_styling(kable(tidy_aft, digits = c(3,3,3,3), 
                    caption = "AFT (log-normal) Model Output (with confounders)",
                    col.names = c("Model Term", "Estimate", "Standard Error", "Test Statistic", "p-Value")),
              latex_options = "HOLD_position")

```{r}
m1 <- lm(jail_time ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior,
   data = data)

data %>%
  #select(police, mobility, parks, publichealth, publicschool, privateschool, charterschool, govtcovid) %>%
  cor() %>%
  ggcorrplot(hc.order = TRUE, type = "lower",
     outline.col = "white", lab = T, lab_size = 2, tl.cex = 8, show.legend = F)


survdata %<>%
  filter(!is.na(jail_time)) %>%
  mutate(jail_time = ifelse(jail_time == 0, 0.00001, jail_time))

aft_ln <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                  dist = "lognormal")

aft_e <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata,  
                 dist = "exponential")

aft_w <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                 dist = "weibull")

aft_l <- survreg(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata, 
                 dist = "loglogistic")

coxm1 <- coxph(Surv(jail_time, censored) ~ controlling_offense + arrested_during_status 
                  + firearm_at_offense + alc_at_offense + drug_at_offense 
                  + arrest_year + held_by + state 
                  + age_at_arrest + race + sex + citizen + military + education + homeless_12mo_prior, 
                  data = survdata)

names(coxm1$coefficients) <- c("One-and-Done Status",
                                "Plays Position F",
                                "Plays Position G",
                                "Player Height (in)",
                                "Foreign Nationality")

ggcoxdiagnostics(coxm1, type = "schoenfeld", title = "Figure 8: Schoenfeld Residuals of Cox PH Model with All Confounders",
                 xlab = "Observation ID", ylab = "Schoenfeld Residuals")

names(coxm2$coefficients) <- c("One-and-Done Status",
                                "Player Height (in)")

ggcoxdiagnostics(coxm2, type = "schoenfeld", title = "Figure 9: Schoenfeld Residuals of Cox PH Model with Player Height",
                 xlab = "Observation ID", ylab = "Schoenfeld Residuals")

resids <- (log(survdata$jail_time) - aft_ln$linear.predictors) / (aft_ln$scale)
m1 <- survfit(Surv(resids, censored) ~ 1, data = survdata)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Log-Normal Model with All Confounders")
exp.x <- seq(min(resids), max(resids), length = 100)
exp.y <- pnorm(exp.x, lower.tail = F)
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata$jail_time) - aft_e$linear.predictors) / (aft_e$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Exponential Model with All Confounders")
exp.y <- exp(-exp(exp.x))
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata$jail_time) - aft_w$linear.predictors) / (aft_w$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Weibull Model with All Confounders")
exp.y <- exp(-exp(exp.x))
lines(exp.x, exp.y, col = "red", lwd = 2)

resids <- (log(survdata$jail_time) - aft_l$linear.predictors) / (aft_l$scale)
plot(m1, xlab = "AFT Residuals", 
     ylab = "Survival Probability", 
     main = "Logistic Model with All Confounders")
exp.y <- plogis(exp.x, lower.tail = F)
lines(exp.x, exp.y, col = "red", lwd = 2)
```

race, 

maybe model time until trial??? or sentencing?? so whether or not still awaiting trial = censoring, time in jail + any additional prison time = days, lots of demographic factors as covariates and potentially other values

arrest date
admission to prison date

censoring: sentenced


how long people wait for trial
possible focuses: were they homeless (V0961), race, 

what contributes to how much time people spend in jail pre-trial

outcome = time in jail + time in prison pre-sentencing
censoring = have you been sentenced (no = censored)
look at attributes law enforcement and DA would know about -- racial groups, crime type, firearm, victim type


```{r}
# MICE imputation
imput_data <- prison %>%
  select(current_age, race, sex, citizen, military, education, homeless_12mo_prior, arrest_year, admit_year,
         held_by, state, controlling_offense, controlling_offense_type, arrested_during_status,
         firearm_at_offense, alc_at_offense, drug_at_offense, age_at_arrest) %>%
  mutate(across(c(current_age, race, sex, citizen, military, education, homeless_12mo_prior, arrest_year,
                  admit_year, held_by, state, controlling_offense, controlling_offense_type, 
                  arrested_during_status, firearm_at_offense, alc_at_offense, drug_at_offense, age_at_arrest),
                as.factor))

imput_data.imp = mice(imput_data, m = 5, seed = 123)
df1 = complete(imput_data.imp, 1)
df2 = complete(imput_data.imp, 2)
df3 = complete(imput_data.imp, 3)
df4 = complete(imput_data.imp, 4)
df5 = complete(imput_data.imp, 5)

getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

# average 4 datasets to get 1 dataset
results <- c()

for (i in 1:ncol(df1)){
  if (typeof(df1[,i]) == "double"){
    list_of_val <- c()
    for (j in 1:nrow(df1)){
      values <- c(df1[j,i], df2[j,i], df3[j,i], df4[j,i], df5[j,i])
      list_of_val <- c(list_of_val, mean(values))
    }
    results <- c(results, list_of_val)
    list_of_val <- c()
  } else{
    list_of_val <- c()
     for (j in 1:nrow(df1)){
      values <- c(df1[j,i], df2[j,i], df3[j,i], df4[j,i], df5[j,i])
      list_of_val <- c(list_of_val, getmode(values))
     }
    results <- c(results, list_of_val)
  }
}

age <- results[1:848]
gender <- results[849:1696]
hispanic <- results[1697: 2544]
income <- results[2545:3392]
yrs_in_durham <- results[3393:4240]
own_or_rent <- results[4241:5088]
race_ethnicity <- results[5089:5936]

completed_data_1 <- tibble(age, gender, hispanic, income, yrs_in_durham, own_or_rent, race_ethnicity)
```


## References
drop column labels from rda
https://stackoverflow.com/questions/61071655/r-extract-labels-from-a-rda-data-frame





